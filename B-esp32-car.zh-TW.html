<!DOCTYPE html><html><head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noindex">

        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.0.3/styles/default.min.css">
        <link rel="stylesheet" href="tomorrow-night.css">

        <link rel="shortcut icon" type="image/png" href="favicon.png">
        <link rel="stylesheet" href="style.css">
        <script src="locale.js"></script>

        <title id="title">ESP32 遙控車</title>
    </head>
    <body>
        <div id="header">
            <h1><a href="index.html">Rio's Blog</a></h1>
        </div>
        <div id="content"><h1 id="title">ESP32 遙控車</h1>
<h2 id="date">2021-02-22</h2>
<p>由於COVID關係，我在開學前多了一些時間在家可以做個東西玩玩。所以就想說把之前的<a href="6-arduino-car.zh-TW.html" rel="noopener noreferrer" target="_blank">Arduino
小車</a>重新做一遍。</p>
<p><img src="img/espcar.jpg" alt="" width="100%" height="auto" srcset="img/espcar.jpg.webp" loading="lazy"></p>
<p>主要想加的功能有：</p>
<ul>
<li>減低視訊延遲</li>
<li>新增音訊串流（未完成）</li>
<li>利用自製電路把馬達控制，音訊放大，電源供應等功能結合到一塊板子上</li>
</ul>
<p>這次又是用 ESP32 來做。ESP32 的 wifi 功能和 ESP-IDF
的各種程式很好用，尤其是我用的 ESP32-CAM 板子還自帶相機讓它很適合用在這台車上。</p>
<p></p><center>
<img src="img/espcar-sch.png" alt="" width="100%" height="auto" srcset="img/espcar-sch.png.webp" loading="lazy"><p></p>
<p>控制版電路圖
</p></center><p></p>
<p>因為本來想要加音訊的關係，我把 ESP32-CAM 的一個 LED
拔了，然後再把相機控制線接到永遠是開著的狀態來把 GPIO32 跟 GPIO23 空出來用它們的
ADC。（不過到最後沒有時間把音訊搞好所以沒用到）。</p>
<p>除此之外，就是把各個部件跟 ESP32 的 IO
接腳連起來。我用了個原型板來組這個電路，實體接線有一點亂不過還能用。</p>
<p>音訊電路是有再麵包板上測試過，是能把麥克風訊號放到大約 1V
左右的振幅。可是不知道為什麼到了原型板上就量不到了。由於我那時只剩幾天的時間就要出門了，
就想說先把音訊的部份放著，其他部份做好先。</p>
<p>馬達控制氣用的是 LD293D，透過 ESP-IDF 的 MCPWM 程式庫控制。</p>
<p>之前做<a href="/9/-telescope.zh-TW.html" rel="noopener noreferrer" target="_blank">我的望遠鏡</a> 時 Solidworks
害我打不開我自己做的檔案。所以這次不想用它，而是用 FreeCAD
做了個架子來把整個板子立在車上。我還做了對耳朵來放麥克風，
不過後來音訊沒時間弄所以沒裝起來。</p>
<p></p><center>
<img src="img/car-freecad.png" alt="" width="100%" height="auto" srcset="img/car-freecad.png.webp" loading="lazy"><p></p>
<p>FreeCAD 模型
</p></center><p></p>
<p>這台車軔體主要有兩個部份：一個視訊任務把相機緩衝裡的資料透過網路送出去；
一個控制任務來接受來自網路的指令然後控制馬達。這兩個任務都是用 ESP-IDF 給的 FreeRTOS
來管理。由於我覺得資造包比串流好用，網路跟指令我都用 UDP 在傳。除此之外，UDP
還有低延遲的好處。（我是希望 SCTP 能有多一點人用，要不是 LWIP
不支持的話我指令部份就用它了）。</p>
<p>影片的話偶爾掉幾幀沒什麼關係，所以只用 UDP 沒什麼問題。我試著把 JPEG
串流直接丟給 ffplay 居然可以直接播。（用 JPEG
格式是因為相機支持，然後又有壓縮過，所以 FPS 可以比較高）。</p>
<p></p><center><p></p>
<iframe width="560" height="315" style="width: 100%" src="https://www.youtube.com/embed/SgkToEtFtQo" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe>
<p>透過 UDP 傳送的視訊
</p></center><p></p>
<p>控制指令部份我用了個簡單的機制來確保小車是處於遠端控制想要的狀態。基本上就是軔體每隔
一段時間就會把自己的狀態傳送給控制端，如果控制端接收到的狀態跟它想要的狀態不一樣的話
它就會送出需要的指令來讓它變一樣。在這之外我還放了個類似看門狗的計時器來在超過一段時
間沒收到資料的情況下把所有馬達停止。這個機制在網路流量方面來看不是最有效率的，不過算
是個在 UDP 下保證指令抵達目的地的簡單辦法。</p>
<p>我在出門前最後一天寫了個 Python 程式來當控制端。Python
有一堆有的沒的套件可以直接用，像是 <code>socket</code>、<code>struct</code>、<code>subprocess</code>
的功能就可以把從 UDP 傳來的視訊丟給 ffplay 播；<code>pynput</code> 可以不用 GUI
或是遊戲引擎就能拿到滑鼠鍵盤的輸入； 再加上 <code>dnspython</code> 可以透過 MDNS
來找到區網上的 ESP32。只要寫個簡單的程式就可以做出控制端。不是很花俏，能用就好。</p>
<p>這次主要的問題其實是用了線性穩壓器。Wifi 其實會用很多電（大約幾百毫安），然後它
又得把電池的8伏轉成3.3伏，這麼大的電壓差加上電流導致很多能源變成熱浪費掉了。這也是
為什麼最後沒有接伺服馬達的原因。下次應該用開關式穩壓器來提供電源。</p>
<p>不過整體說還算是成功，跟之前 Android + Arduino
的小車比起來延遲低很多。我對於能在出門又弄一台遙控車出來還算是滿意。</p>
<p>程式碼、電路圖跟3D模型都有放在 <a href="https://github.com/Rio6/ESPCar" rel="noopener noreferrer" target="_blank">Github</a> 上。</p></div>
        <div id="footer">
            Made by Rio
        </div>
        <ul tabindex="0" id="lang-select"><li>繁體中文</li>
            <li>
                <a href="B-esp32-car.en.html">
                    English
                </a>
            </li>
        </ul>
    

</body></html>